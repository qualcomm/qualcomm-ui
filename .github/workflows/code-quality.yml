name: "PR Checks"
on:
  pull_request:
    # Run every time a PR to origin/main is created or updated
    types: [ "opened", "synchronize" ]
    branches: [ "main", "dev" ]
  workflow_dispatch:

env:
  BRANCH_NAME: ${{ github.head_ref || github.ref_name }}

jobs:
  lint:
    env:
      IS_CI: true
    runs-on: self-hosted
    strategy:
      matrix:
        shardIndex: [ 1, 2, 3 ]
        shardTotal: [ 3 ]
    concurrency:
      group: PR Lint - ${{matrix.shardIndex}} - ${{github.head_ref}}
      cancel-in-progress: true
    timeout-minutes: 10
    steps:
    - name: clone
      id: install
      uses: actions/checkout@v3
      with:
        ref: ${{ github.head_ref }}

    - name: install
      run: node scripts/pre-install-ci.mjs && pnpm i

    - name: lint
      run: pnpm tsx scripts/lint-shard.ts --shard=${{matrix.shardIndex}}/${{matrix.shardTotal}}

  build:
    env:
      IS_CI: true
    runs-on: self-hosted
    concurrency:
      group: PR Build - ${{github.head_ref}}
      cancel-in-progress: true
    timeout-minutes: 10
    steps:
    - name: clone and install
      id: install
      uses: actions/checkout@v3
      with:
        ref: ${{ github.head_ref }}
    - run: pnpm i

    - name: build
      run: pnpm run build
